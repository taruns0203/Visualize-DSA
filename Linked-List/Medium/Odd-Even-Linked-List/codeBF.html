<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Code Snippet Whiteboard Explainer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Patrick+Hand&family=Kalam:wght@300;400;700&family=Permanent+Marker&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Kalam", cursive;
        min-height: 100vh;
        background: #1a1a2e;
      }

      /* Theme variables */
      :root {
        --bg-primary: #1a1a2e;
        --bg-secondary: #16213e;
        --bg-tertiary: #0f3460;
        --accent-green: #00ff88;
        --accent-red: #ff6b6b;
        --accent-yellow: #ffd700;
        --accent-blue: #667eea;
        --accent-purple: #9b59b6;
        --accent-orange: #f39c12;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --border-color: rgba(255, 255, 255, 0.2);
      }

      .light-theme {
        --bg-primary: #f5f5f0;
        --bg-secondary: #ffffff;
        --bg-tertiary: #e8e4db;
        --accent-green: #27ae60;
        --accent-red: #e74c3c;
        --accent-yellow: #f39c12;
        --accent-blue: #3498db;
        --accent-purple: #9b59b6;
        --accent-orange: #e67e22;
        --text-primary: #2c3e50;
        --text-secondary: #7f8c8d;
        --border-color: rgba(0, 0, 0, 0.2);
      }

      /* Main layout */
      .app-container {
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 300px;
        background: var(--bg-secondary);
        border-right: 3px solid var(--border-color);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        max-height: 100vh;
      }

      .sidebar-title {
        font-family: "Permanent Marker", cursive;
        font-size: 1.4rem;
        color: var(--accent-yellow);
        text-align: center;
        padding-bottom: 15px;
        border-bottom: 2px dashed var(--border-color);
      }

      /* Buttons */
      .btn {
        font-family: "Patrick Hand", cursive;
        font-size: 1.1rem;
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--accent-blue) 0%,
          var(--accent-purple) 100%
        );
        color: white;
      }

      .btn-success {
        background: linear-gradient(
          135deg,
          var(--accent-green) 0%,
          #00cc6a 100%
        );
        color: #1a1a2e;
      }

      .btn-danger {
        background: linear-gradient(135deg, var(--accent-red) 0%, #ee5a5a 100%);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(
          135deg,
          var(--accent-yellow) 0%,
          var(--accent-orange) 100%
        );
        color: #1a1a2e;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 0.95rem;
      }

      /* Theme toggle */
      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px;
        background: var(--bg-tertiary);
        border-radius: 8px;
      }

      .theme-toggle span {
        font-size: 1.2rem;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: var(--bg-primary);
        border-radius: 13px;
        cursor: pointer;
        border: 2px solid var(--border-color);
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 18px;
        height: 18px;
        background: var(--accent-yellow);
        border-radius: 50%;
        transition: transform 0.3s ease;
      }

      .toggle-switch.light::after {
        transform: translateX(24px);
      }

      /* Tools section */
      .tools-section {
        background: var(--bg-tertiary);
        border-radius: 12px;
        padding: 15px;
      }

      .tools-section h3 {
        font-family: "Caveat", cursive;
        font-size: 1.4rem;
        color: var(--text-primary);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tool-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }

      .tool-btn {
        width: 100%;
        aspect-ratio: 1;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 1.3rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .tool-btn:hover {
        border-color: var(--accent-blue);
        background: rgba(102, 126, 234, 0.2);
      }

      .tool-btn.active {
        border-color: var(--accent-green);
        background: rgba(0, 255, 136, 0.2);
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
      }

      /* Color picker */
      .color-section {
        margin-top: 12px;
      }

      .color-section label {
        font-family: "Patrick Hand", cursive;
        font-size: 1rem;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 8px;
      }

      .color-grid {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .color-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .color-btn:hover {
        transform: scale(1.15);
      }

      .color-btn.active {
        border-color: white;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      /* Stroke width */
      .stroke-section {
        margin-top: 12px;
      }

      .stroke-section label {
        font-family: "Patrick Hand", cursive;
        font-size: 1rem;
        color: var(--text-secondary);
        display: block;
        margin-bottom: 8px;
      }

      .stroke-slider {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: var(--bg-primary);
        outline: none;
        -webkit-appearance: none;
      }

      .stroke-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--accent-blue);
        cursor: pointer;
      }

      /* Annotations list */
      .annotations-section {
        background: var(--bg-tertiary);
        border-radius: 12px;
        padding: 15px;
        flex: 1;
        overflow-y: auto;
      }

      .annotations-section h3 {
        font-family: "Caveat", cursive;
        font-size: 1.4rem;
        color: var(--text-primary);
        margin-bottom: 12px;
      }

      .annotation-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
      }

      .annotation-item {
        background: var(--bg-primary);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .annotation-item:hover {
        border-color: var(--accent-blue);
      }

      .annotation-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .annotation-text {
        flex: 1;
        font-family: "Patrick Hand", cursive;
        font-size: 0.95rem;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .annotation-delete {
        background: none;
        border: none;
        color: var(--accent-red);
        cursor: pointer;
        font-size: 1.1rem;
        opacity: 0.6;
        transition: opacity 0.2s;
      }

      .annotation-delete:hover {
        opacity: 1;
      }

      /* Main canvas area */
      .canvas-area {
        flex: 1;
        background: var(--bg-primary);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Toolbar */
      .toolbar {
        background: var(--bg-secondary);
        border-bottom: 2px solid var(--border-color);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .toolbar-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toolbar-divider {
        width: 2px;
        height: 30px;
        background: var(--border-color);
      }

      .zoom-display {
        font-family: "Fira Code", monospace;
        font-size: 0.9rem;
        color: var(--text-secondary);
        background: var(--bg-primary);
        padding: 5px 12px;
        border-radius: 5px;
        min-width: 60px;
        text-align: center;
      }

      /* Canvas container */
      .canvas-container {
        flex: 1;
        overflow: auto;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
            90deg,
            var(--bg-tertiary) 1px,
            transparent 1px
          ),
          linear-gradient(var(--bg-tertiary) 1px, transparent 1px);
        background-size: 20px 20px;
        padding: 20px;
      }

      .canvas-wrapper {
        position: relative;
        display: inline-block;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        overflow: hidden;
        transform-origin: center center;
      }

      #codeImage {
        display: block;
        max-width: 100%;
        height: auto;
      }

      #annotationCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: crosshair;
      }

      /* Text annotation input */
      .text-input-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .text-input-overlay.active {
        display: flex;
      }

      .text-input-box {
        background: var(--bg-secondary);
        border: 3px solid var(--accent-blue);
        border-radius: 12px;
        padding: 25px;
        width: 90%;
        max-width: 500px;
      }

      .text-input-box h3 {
        font-family: "Caveat", cursive;
        font-size: 1.6rem;
        color: var(--text-primary);
        margin-bottom: 15px;
      }

      .text-input-box textarea {
        width: 100%;
        height: 120px;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: "Patrick Hand", cursive;
        font-size: 1.1rem;
        resize: none;
        margin-bottom: 15px;
      }

      .text-input-box textarea:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .text-input-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      /* Export modal */
      .export-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .export-modal.active {
        display: flex;
      }

      .export-content {
        background: var(--bg-secondary);
        border: 3px solid var(--accent-green);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        max-width: 400px;
      }

      .export-content h3 {
        font-family: "Caveat", cursive;
        font-size: 1.8rem;
        color: var(--accent-green);
        margin-bottom: 20px;
      }

      .export-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .export-buttons .btn {
        width: 100%;
        justify-content: center;
      }

      /* Cursor styles */
      .cursor-draw {
        cursor: crosshair;
      }
      .cursor-arrow {
        cursor: default;
      }
      .cursor-text {
        cursor: text;
      }
      .cursor-move {
        cursor: move;
      }
      .cursor-eraser {
        cursor: cell;
      }

      /* Instructions box */
      .instructions-box {
        background: var(--bg-tertiary);
        border: 2px dashed var(--accent-blue);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
      }

      .instructions-box h4 {
        font-family: "Caveat", cursive;
        font-size: 1.2rem;
        color: var(--accent-yellow);
        margin-bottom: 8px;
      }

      .instructions-box p {
        font-family: "Patrick Hand", cursive;
        font-size: 0.95rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .instructions-box code {
        background: var(--bg-primary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "Fira Code", monospace;
        font-size: 0.85rem;
        color: var(--accent-green);
      }

      /* Responsive */
      @media (max-width: 900px) {
        .app-container {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-height: none;
          border-right: none;
          border-bottom: 3px solid var(--border-color);
        }

        .canvas-container {
          min-height: 60vh;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h1 class="sidebar-title">üìù Code Explainer</h1>

        <!-- Theme Toggle -->
        <div class="theme-toggle">
          <span>üåô</span>
          <div class="toggle-switch" id="themeToggle"></div>
          <span>‚òÄÔ∏è</span>
        </div>

        <!-- Instructions -->
        <div class="instructions-box">
          <h4>üí° How to Use</h4>
          <p>
            Change the image by editing the <code>src</code> attribute of the
            <code>&lt;img&gt;</code> tag in the HTML (line ~500). You can use a
            local path or URL.
          </p>
        </div>

        <!-- Tools Section -->
        <div class="tools-section">
          <h3>üõ†Ô∏è Annotation Tools</h3>
          <div class="tool-grid">
            <button
              class="tool-btn active"
              data-tool="select"
              title="Select (V)"
            >
              üëÜ
            </button>
            <button class="tool-btn" data-tool="pen" title="Pen (P)">‚úèÔ∏è</button>
            <button
              class="tool-btn"
              data-tool="highlighter"
              title="Highlighter (H)"
            >
              üñçÔ∏è
            </button>
            <button class="tool-btn" data-tool="arrow" title="Arrow (A)">
              ‚û°Ô∏è
            </button>
            <button
              class="tool-btn"
              data-tool="rectangle"
              title="Rectangle (R)"
            >
              ‚¨ú
            </button>
            <button class="tool-btn" data-tool="circle" title="Circle (C)">
              ‚≠ï
            </button>
            <button class="tool-btn" data-tool="text" title="Text (T)">
              üî§
            </button>
            <button class="tool-btn" data-tool="eraser" title="Eraser (E)">
              üßπ
            </button>
          </div>

          <!-- Color Picker -->
          <div class="color-section">
            <label>üé® Color:</label>
            <div class="color-grid">
              <button
                class="color-btn active"
                data-color="#ff6b6b"
                style="background: #ff6b6b"
              ></button>
              <button
                class="color-btn"
                data-color="#00ff88"
                style="background: #00ff88"
              ></button>
              <button
                class="color-btn"
                data-color="#ffd700"
                style="background: #ffd700"
              ></button>
              <button
                class="color-btn"
                data-color="#667eea"
                style="background: #667eea"
              ></button>
              <button
                class="color-btn"
                data-color="#ff9ff3"
                style="background: #ff9ff3"
              ></button>
              <button
                class="color-btn"
                data-color="#54a0ff"
                style="background: #54a0ff"
              ></button>
              <button
                class="color-btn"
                data-color="#ffffff"
                style="background: #ffffff"
              ></button>
              <button
                class="color-btn"
                data-color="#2c3e50"
                style="background: #2c3e50"
              ></button>
            </div>
          </div>

          <!-- Stroke Width -->
          <div class="stroke-section">
            <label>üìè Stroke: <span id="strokeValue">3</span>px</label>
            <input
              type="range"
              class="stroke-slider"
              id="strokeSlider"
              min="1"
              max="20"
              value="3"
            />
          </div>
        </div>

        <!-- Annotations List -->
        <div class="annotations-section">
          <h3>üìã Annotations (<span id="annotationCount">0</span>)</h3>
          <div class="annotation-list" id="annotationList">
            <p
              style="
                color: var(--text-secondary);
                font-family: 'Patrick Hand', cursive;
                text-align: center;
                padding: 20px;
              "
            >
              No annotations yet.<br />Start drawing on the image!
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 10px">
          <button class="btn btn-danger" id="clearAllBtn" style="flex: 1">
            üóëÔ∏è Clear
          </button>
          <button class="btn btn-success" id="exportBtn" style="flex: 1">
            üíæ Export
          </button>
        </div>
      </aside>

      <!-- Main Canvas Area -->
      <main class="canvas-area">
        <!-- Toolbar -->
        <div class="toolbar">
          <div class="toolbar-group">
            <button
              class="btn btn-small btn-primary"
              id="undoBtn"
              title="Undo (Ctrl+Z)"
            >
              ‚Ü©Ô∏è Undo
            </button>
            <button
              class="btn btn-small btn-primary"
              id="redoBtn"
              title="Redo (Ctrl+Y)"
            >
              ‚Ü™Ô∏è Redo
            </button>
          </div>
          <div class="toolbar-divider"></div>
          <div class="toolbar-group">
            <button class="btn btn-small btn-warning" id="zoomOutBtn">
              ‚ûñ
            </button>
            <span class="zoom-display" id="zoomDisplay">100%</span>
            <button class="btn btn-small btn-warning" id="zoomInBtn">‚ûï</button>
            <button class="btn btn-small btn-warning" id="zoomFitBtn">
              üî≤ Fit
            </button>
          </div>
          <div class="toolbar-divider"></div>
          <div class="toolbar-group">
            <button class="btn btn-small btn-success" id="downloadBtn">
              üì• Download
            </button>
          </div>
        </div>

        <!-- Canvas Container -->
        <div class="canvas-container" id="canvasContainer">
          <div class="canvas-wrapper" id="canvasWrapper">
            <!--
                    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
                    ‚ïë  üñºÔ∏è CHANGE YOUR IMAGE HERE!                                   ‚ïë
                    ‚ïë                                                               ‚ïë
                    ‚ïë  Replace the src attribute below with your image path/URL:    ‚ïë
                    ‚ïë  - Local file: src="./my-code-screenshot.png"                 ‚ïë
                    ‚ïë  - Web URL: src="https://example.com/image.png"               ‚ïë
                    ‚ïë  - Base64: src="data:image/png;base64,..."                    ‚ïë
                    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                    -->
            <img
              id="codeImage"
              src="https://via.placeholder.com/800x500/1e1e1e/00ff88?text=Replace+this+with+your+code+snippet+image"
              alt="Code Snippet"
              crossorigin="anonymous"
            />
            <canvas id="annotationCanvas"></canvas>
          </div>
        </div>
      </main>
    </div>

    <!-- Text Input Overlay -->
    <div class="text-input-overlay" id="textInputOverlay">
      <div class="text-input-box">
        <h3>‚úçÔ∏è Add Text Annotation</h3>
        <textarea
          id="textAnnotationInput"
          placeholder="Enter your explanation here..."
        ></textarea>
        <div class="text-input-actions">
          <button class="btn btn-danger btn-small" id="cancelTextBtn">
            Cancel
          </button>
          <button class="btn btn-success btn-small" id="addTextBtn">
            Add Text
          </button>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="export-modal" id="exportModal">
      <div class="export-content">
        <h3>üíæ Export Options</h3>
        <div class="export-buttons">
          <button class="btn btn-primary" id="exportPngBtn">
            üì∑ Download as PNG
          </button>
          <button class="btn btn-warning" id="exportJpgBtn">
            üñºÔ∏è Download as JPG
          </button>
          <button class="btn btn-success" id="copyClipboardBtn">
            üìã Copy to Clipboard
          </button>
          <button class="btn btn-danger btn-small" id="closeExportBtn">
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // State
      const state = {
        currentTool: "select",
        currentColor: "#ff6b6b",
        strokeWidth: 3,
        zoom: 1,
        isDrawing: false,
        startX: 0,
        startY: 0,
        annotations: [],
        undoStack: [],
        redoStack: [],
        selectedAnnotation: null,
        textPosition: null,
        imageLoaded: false,
      };

      // DOM Elements
      const elements = {
        themeToggle: document.getElementById("themeToggle"),
        toolBtns: document.querySelectorAll(".tool-btn"),
        colorBtns: document.querySelectorAll(".color-btn"),
        strokeSlider: document.getElementById("strokeSlider"),
        strokeValue: document.getElementById("strokeValue"),
        annotationList: document.getElementById("annotationList"),
        annotationCount: document.getElementById("annotationCount"),
        clearAllBtn: document.getElementById("clearAllBtn"),
        exportBtn: document.getElementById("exportBtn"),
        undoBtn: document.getElementById("undoBtn"),
        redoBtn: document.getElementById("redoBtn"),
        zoomInBtn: document.getElementById("zoomInBtn"),
        zoomOutBtn: document.getElementById("zoomOutBtn"),
        zoomFitBtn: document.getElementById("zoomFitBtn"),
        zoomDisplay: document.getElementById("zoomDisplay"),
        downloadBtn: document.getElementById("downloadBtn"),
        canvasContainer: document.getElementById("canvasContainer"),
        canvasWrapper: document.getElementById("canvasWrapper"),
        codeImage: document.getElementById("codeImage"),
        annotationCanvas: document.getElementById("annotationCanvas"),
        textInputOverlay: document.getElementById("textInputOverlay"),
        textAnnotationInput: document.getElementById("textAnnotationInput"),
        cancelTextBtn: document.getElementById("cancelTextBtn"),
        addTextBtn: document.getElementById("addTextBtn"),
        exportModal: document.getElementById("exportModal"),
        exportPngBtn: document.getElementById("exportPngBtn"),
        exportJpgBtn: document.getElementById("exportJpgBtn"),
        copyClipboardBtn: document.getElementById("copyClipboardBtn"),
        closeExportBtn: document.getElementById("closeExportBtn"),
      };

      const ctx = elements.annotationCanvas.getContext("2d");

      // Initialize
      function init() {
        setupEventListeners();
        updateCursor();

        // Wait for image to load
        if (elements.codeImage.complete) {
          initializeCanvas();
        } else {
          elements.codeImage.onload = initializeCanvas;
        }
      }

      function initializeCanvas() {
        state.imageLoaded = true;

        // Set canvas size to match image
        elements.annotationCanvas.width = elements.codeImage.naturalWidth;
        elements.annotationCanvas.height = elements.codeImage.naturalHeight;

        // Fit to screen
        setTimeout(fitToScreen, 100);
      }

      // Event Listeners
      function setupEventListeners() {
        // Theme toggle
        elements.themeToggle.addEventListener("click", toggleTheme);

        // Tools
        elements.toolBtns.forEach((btn) => {
          btn.addEventListener("click", () => selectTool(btn.dataset.tool));
        });

        // Colors
        elements.colorBtns.forEach((btn) => {
          btn.addEventListener("click", () => selectColor(btn.dataset.color));
        });

        // Stroke width
        elements.strokeSlider.addEventListener("input", (e) => {
          state.strokeWidth = parseInt(e.target.value);
          elements.strokeValue.textContent = state.strokeWidth;
        });

        // Canvas events
        elements.annotationCanvas.addEventListener(
          "mousedown",
          handleMouseDown
        );
        elements.annotationCanvas.addEventListener(
          "mousemove",
          handleMouseMove
        );
        elements.annotationCanvas.addEventListener("mouseup", handleMouseUp);
        elements.annotationCanvas.addEventListener("mouseleave", handleMouseUp);

        // Touch events for mobile
        elements.annotationCanvas.addEventListener(
          "touchstart",
          handleTouchStart,
          { passive: false }
        );
        elements.annotationCanvas.addEventListener(
          "touchmove",
          handleTouchMove,
          { passive: false }
        );
        elements.annotationCanvas.addEventListener("touchend", handleTouchEnd);

        // Toolbar buttons
        elements.undoBtn.addEventListener("click", undo);
        elements.redoBtn.addEventListener("click", redo);
        elements.zoomInBtn.addEventListener("click", () =>
          setZoom(state.zoom + 0.1)
        );
        elements.zoomOutBtn.addEventListener("click", () =>
          setZoom(state.zoom - 0.1)
        );
        elements.zoomFitBtn.addEventListener("click", fitToScreen);
        elements.downloadBtn.addEventListener("click", downloadImage);
        elements.clearAllBtn.addEventListener("click", clearAllAnnotations);
        elements.exportBtn.addEventListener("click", () =>
          elements.exportModal.classList.add("active")
        );

        // Text input
        elements.cancelTextBtn.addEventListener("click", cancelTextInput);
        elements.addTextBtn.addEventListener("click", addTextAnnotation);

        // Export modal
        elements.exportPngBtn.addEventListener("click", () =>
          exportImage("png")
        );
        elements.exportJpgBtn.addEventListener("click", () =>
          exportImage("jpg")
        );
        elements.copyClipboardBtn.addEventListener("click", copyToClipboard);
        elements.closeExportBtn.addEventListener("click", () =>
          elements.exportModal.classList.remove("active")
        );

        // Keyboard shortcuts
        document.addEventListener("keydown", handleKeyboard);
      }

      // Theme
      function toggleTheme() {
        document.body.classList.toggle("light-theme");
        elements.themeToggle.classList.toggle("light");
      }

      // Tools
      function selectTool(tool) {
        state.currentTool = tool;
        elements.toolBtns.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.tool === tool);
        });
        updateCursor();
      }

      function selectColor(color) {
        state.currentColor = color;
        elements.colorBtns.forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.color === color);
        });
      }

      function updateCursor() {
        const canvas = elements.annotationCanvas;
        canvas.className = "";
        switch (state.currentTool) {
          case "select":
            canvas.classList.add("cursor-arrow");
            break;
          case "text":
            canvas.classList.add("cursor-text");
            break;
          case "eraser":
            canvas.classList.add("cursor-eraser");
            break;
          default:
            canvas.classList.add("cursor-draw");
        }
      }

      // Drawing
      function getCanvasCoords(e) {
        const rect = elements.annotationCanvas.getBoundingClientRect();
        const scaleX = elements.annotationCanvas.width / rect.width;
        const scaleY = elements.annotationCanvas.height / rect.height;
        return {
          x: (e.clientX - rect.left) * scaleX,
          y: (e.clientY - rect.top) * scaleY,
        };
      }

      function handleMouseDown(e) {
        if (!state.imageLoaded) return;

        const coords = getCanvasCoords(e);
        state.isDrawing = true;
        state.startX = coords.x;
        state.startY = coords.y;

        if (
          state.currentTool === "pen" ||
          state.currentTool === "highlighter"
        ) {
          state.currentPath = [{ x: coords.x, y: coords.y }];
        } else if (state.currentTool === "text") {
          state.textPosition = coords;
          elements.textInputOverlay.classList.add("active");
          elements.textAnnotationInput.focus();
        } else if (state.currentTool === "eraser") {
          eraseAt(coords.x, coords.y);
        }
      }

      function handleMouseMove(e) {
        if (!state.isDrawing || !state.imageLoaded) return;

        const coords = getCanvasCoords(e);

        if (
          state.currentTool === "pen" ||
          state.currentTool === "highlighter"
        ) {
          state.currentPath.push({ x: coords.x, y: coords.y });
          redrawCanvas();
          drawPath(
            state.currentPath,
            state.currentColor,
            state.strokeWidth,
            state.currentTool === "highlighter"
          );
        } else if (
          state.currentTool === "arrow" ||
          state.currentTool === "rectangle" ||
          state.currentTool === "circle"
        ) {
          redrawCanvas();
          drawShape(
            state.currentTool,
            state.startX,
            state.startY,
            coords.x,
            coords.y,
            state.currentColor,
            state.strokeWidth,
            true
          );
        } else if (state.currentTool === "eraser") {
          eraseAt(coords.x, coords.y);
        }
      }

      function handleMouseUp(e) {
        if (!state.isDrawing || !state.imageLoaded) return;
        state.isDrawing = false;

        const coords = getCanvasCoords(e);

        if (
          state.currentTool === "pen" ||
          state.currentTool === "highlighter"
        ) {
          if (state.currentPath && state.currentPath.length > 1) {
            addAnnotation({
              type: state.currentTool,
              path: [...state.currentPath],
              color: state.currentColor,
              strokeWidth: state.strokeWidth,
            });
          }
          state.currentPath = null;
        } else if (
          state.currentTool === "arrow" ||
          state.currentTool === "rectangle" ||
          state.currentTool === "circle"
        ) {
          if (
            Math.abs(coords.x - state.startX) > 5 ||
            Math.abs(coords.y - state.startY) > 5
          ) {
            addAnnotation({
              type: state.currentTool,
              x1: state.startX,
              y1: state.startY,
              x2: coords.x,
              y2: coords.y,
              color: state.currentColor,
              strokeWidth: state.strokeWidth,
            });
          }
        }
      }

      // Touch handling
      function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousedown", {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        handleMouseDown(mouseEvent);
      }

      function handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent("mousemove", {
          clientX: touch.clientX,
          clientY: touch.clientY,
        });
        handleMouseMove(mouseEvent);
      }

      function handleTouchEnd(e) {
        const mouseEvent = new MouseEvent("mouseup", {});
        handleMouseUp(mouseEvent);
      }

      // Drawing functions
      function drawPath(path, color, strokeWidth, isHighlighter = false) {
        if (path.length < 2) return;

        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);

        for (let i = 1; i < path.length; i++) {
          ctx.lineTo(path[i].x, path[i].y);
        }

        ctx.strokeStyle = color;
        ctx.lineWidth = strokeWidth;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        if (isHighlighter) {
          ctx.globalAlpha = 0.4;
          ctx.lineWidth = strokeWidth * 3;
        } else {
          ctx.globalAlpha = 1;
        }

        ctx.stroke();
        ctx.globalAlpha = 1;
      }

      function drawShape(
        type,
        x1,
        y1,
        x2,
        y2,
        color,
        strokeWidth,
        preview = false
      ) {
        ctx.strokeStyle = color;
        ctx.lineWidth = strokeWidth;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";

        if (type === "arrow") {
          // Draw line
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();

          // Draw arrowhead
          const angle = Math.atan2(y2 - y1, x2 - x1);
          const headLength = 15 + strokeWidth * 2;

          ctx.beginPath();
          ctx.moveTo(x2, y2);
          ctx.lineTo(
            x2 - headLength * Math.cos(angle - Math.PI / 6),
            y2 - headLength * Math.sin(angle - Math.PI / 6)
          );
          ctx.moveTo(x2, y2);
          ctx.lineTo(
            x2 - headLength * Math.cos(angle + Math.PI / 6),
            y2 - headLength * Math.sin(angle + Math.PI / 6)
          );
          ctx.stroke();
        } else if (type === "rectangle") {
          ctx.beginPath();
          ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
        } else if (type === "circle") {
          const rx = Math.abs(x2 - x1) / 2;
          const ry = Math.abs(y2 - y1) / 2;
          const cx = x1 + (x2 - x1) / 2;
          const cy = y1 + (y2 - y1) / 2;

          ctx.beginPath();
          ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
          ctx.stroke();
        }
      }

      function drawText(text, x, y, color, fontSize = 20) {
        ctx.font = `${fontSize}px 'Patrick Hand', cursive`;
        ctx.fillStyle = color;

        // Handle multi-line text
        const lines = text.split("\n");
        lines.forEach((line, index) => {
          ctx.fillText(line, x, y + index * fontSize * 1.2);
        });
      }

      // Annotation management
      function addAnnotation(annotation) {
        annotation.id = Date.now();
        state.annotations.push(annotation);
        state.undoStack.push({ action: "add", annotation });
        state.redoStack = [];
        updateAnnotationList();
        redrawCanvas();
      }

      function removeAnnotation(id) {
        const index = state.annotations.findIndex((a) => a.id === id);
        if (index !== -1) {
          const annotation = state.annotations.splice(index, 1)[0];
          state.undoStack.push({ action: "remove", annotation, index });
          state.redoStack = [];
          updateAnnotationList();
          redrawCanvas();
        }
      }

      // Make removeAnnotation globally accessible
      window.removeAnnotation = removeAnnotation;

      function eraseAt(x, y) {
        const eraseRadius = state.strokeWidth * 5;
        let erased = false;

        state.annotations = state.annotations.filter((a) => {
          if (a.type === "pen" || a.type === "highlighter") {
            for (let point of a.path) {
              if (Math.hypot(point.x - x, point.y - y) < eraseRadius) {
                erased = true;
                return false;
              }
            }
          } else if (a.type === "text") {
            if (Math.hypot(a.x - x, a.y - y) < eraseRadius * 2) {
              erased = true;
              return false;
            }
          } else {
            const cx = (a.x1 + a.x2) / 2;
            const cy = (a.y1 + a.y2) / 2;
            if (Math.hypot(cx - x, cy - y) < eraseRadius * 2) {
              erased = true;
              return false;
            }
          }
          return true;
        });

        if (erased) {
          updateAnnotationList();
          redrawCanvas();
        }
      }

      function clearAllAnnotations() {
        if (state.annotations.length === 0) return;
        if (confirm("Are you sure you want to clear all annotations?")) {
          state.undoStack.push({
            action: "clear",
            annotations: [...state.annotations],
          });
          state.annotations = [];
          state.redoStack = [];
          updateAnnotationList();
          redrawCanvas();
        }
      }

      function redrawCanvas() {
        ctx.clearRect(
          0,
          0,
          elements.annotationCanvas.width,
          elements.annotationCanvas.height
        );

        for (let annotation of state.annotations) {
          if (annotation.type === "pen" || annotation.type === "highlighter") {
            drawPath(
              annotation.path,
              annotation.color,
              annotation.strokeWidth,
              annotation.type === "highlighter"
            );
          } else if (annotation.type === "text") {
            drawText(
              annotation.text,
              annotation.x,
              annotation.y,
              annotation.color,
              annotation.fontSize
            );
          } else {
            drawShape(
              annotation.type,
              annotation.x1,
              annotation.y1,
              annotation.x2,
              annotation.y2,
              annotation.color,
              annotation.strokeWidth
            );
          }
        }
      }

      function updateAnnotationList() {
        elements.annotationCount.textContent = state.annotations.length;

        if (state.annotations.length === 0) {
          elements.annotationList.innerHTML = `
                    <p style="color: var(--text-secondary); font-family: 'Patrick Hand', cursive; text-align: center; padding: 20px;">
                        No annotations yet.<br>Start drawing on the image!
                    </p>
                `;
          return;
        }

        elements.annotationList.innerHTML = state.annotations
          .map((a) => {
            let label = "";
            switch (a.type) {
              case "pen":
                label = "‚úèÔ∏è Pen stroke";
                break;
              case "highlighter":
                label = "üñçÔ∏è Highlight";
                break;
              case "arrow":
                label = "‚û°Ô∏è Arrow";
                break;
              case "rectangle":
                label = "‚¨ú Rectangle";
                break;
              case "circle":
                label = "‚≠ï Circle";
                break;
              case "text":
                label = `üî§ "${a.text.substring(0, 15)}${
                  a.text.length > 15 ? "..." : ""
                }"`;
                break;
            }
            return `
                    <div class="annotation-item" data-id="${a.id}">
                        <div class="annotation-color" style="background: ${a.color}"></div>
                        <span class="annotation-text">${label}</span>
                        <button class="annotation-delete" onclick="removeAnnotation(${a.id})">√ó</button>
                    </div>
                `;
          })
          .join("");
      }

      // Undo/Redo
      function undo() {
        if (state.undoStack.length === 0) return;
        const action = state.undoStack.pop();

        if (action.action === "add") {
          const index = state.annotations.findIndex(
            (a) => a.id === action.annotation.id
          );
          if (index !== -1) state.annotations.splice(index, 1);
        } else if (action.action === "remove") {
          state.annotations.splice(action.index, 0, action.annotation);
        } else if (action.action === "clear") {
          state.annotations = action.annotations;
        }

        state.redoStack.push(action);
        updateAnnotationList();
        redrawCanvas();
      }

      function redo() {
        if (state.redoStack.length === 0) return;
        const action = state.redoStack.pop();

        if (action.action === "add") {
          state.annotations.push(action.annotation);
        } else if (action.action === "remove") {
          const index = state.annotations.findIndex(
            (a) => a.id === action.annotation.id
          );
          if (index !== -1) state.annotations.splice(index, 1);
        } else if (action.action === "clear") {
          state.annotations = [];
        }

        state.undoStack.push(action);
        updateAnnotationList();
        redrawCanvas();
      }

      // Zoom
      function setZoom(level) {
        state.zoom = Math.max(0.25, Math.min(3, level));
        elements.canvasWrapper.style.transform = `scale(${state.zoom})`;
        elements.zoomDisplay.textContent = `${Math.round(state.zoom * 100)}%`;
      }

      function fitToScreen() {
        if (!state.imageLoaded) return;
        const containerRect = elements.canvasContainer.getBoundingClientRect();
        const imageWidth = elements.codeImage.naturalWidth;
        const imageHeight = elements.codeImage.naturalHeight;

        const scaleX = (containerRect.width - 40) / imageWidth;
        const scaleY = (containerRect.height - 40) / imageHeight;
        const scale = Math.min(scaleX, scaleY, 1);

        setZoom(scale);
      }

      // Text annotation
      function cancelTextInput() {
        elements.textInputOverlay.classList.remove("active");
        elements.textAnnotationInput.value = "";
        state.textPosition = null;
      }

      function addTextAnnotation() {
        const text = elements.textAnnotationInput.value.trim();
        if (text && state.textPosition) {
          addAnnotation({
            type: "text",
            text: text,
            x: state.textPosition.x,
            y: state.textPosition.y,
            color: state.currentColor,
            fontSize: state.strokeWidth * 6 + 12,
          });
        }
        cancelTextInput();
      }

      // Export functions
      function exportImage(format) {
        const exportCanvas = document.createElement("canvas");
        exportCanvas.width = elements.annotationCanvas.width;
        exportCanvas.height = elements.annotationCanvas.height;
        const exportCtx = exportCanvas.getContext("2d");

        // Draw image
        exportCtx.drawImage(elements.codeImage, 0, 0);
        // Draw annotations
        exportCtx.drawImage(elements.annotationCanvas, 0, 0);

        const mimeType = format === "jpg" ? "image/jpeg" : "image/png";
        const dataUrl = exportCanvas.toDataURL(mimeType, 0.95);

        const link = document.createElement("a");
        link.download = `code-explanation.${format}`;
        link.href = dataUrl;
        link.click();

        elements.exportModal.classList.remove("active");
      }

      function downloadImage() {
        exportImage("png");
      }

      async function copyToClipboard() {
        const exportCanvas = document.createElement("canvas");
        exportCanvas.width = elements.annotationCanvas.width;
        exportCanvas.height = elements.annotationCanvas.height;
        const exportCtx = exportCanvas.getContext("2d");

        exportCtx.drawImage(elements.codeImage, 0, 0);
        exportCtx.drawImage(elements.annotationCanvas, 0, 0);

        try {
          const blob = await new Promise((resolve) =>
            exportCanvas.toBlob(resolve, "image/png")
          );
          await navigator.clipboard.write([
            new ClipboardItem({ "image/png": blob }),
          ]);
          alert("Image copied to clipboard!");
        } catch (err) {
          alert("Failed to copy to clipboard. Please use Download instead.");
        }

        elements.exportModal.classList.remove("active");
      }

      // Keyboard shortcuts
      function handleKeyboard(e) {
        // Don't handle if typing in input
        if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA")
          return;

        if (e.ctrlKey || e.metaKey) {
          if (e.key === "z") {
            e.preventDefault();
            if (e.shiftKey) redo();
            else undo();
          } else if (e.key === "y") {
            e.preventDefault();
            redo();
          } else if (e.key === "s") {
            e.preventDefault();
            downloadImage();
          }
          return;
        }

        switch (e.key.toLowerCase()) {
          case "v":
            selectTool("select");
            break;
          case "p":
            selectTool("pen");
            break;
          case "h":
            selectTool("highlighter");
            break;
          case "a":
            selectTool("arrow");
            break;
          case "r":
            selectTool("rectangle");
            break;
          case "c":
            selectTool("circle");
            break;
          case "t":
            selectTool("text");
            break;
          case "e":
            selectTool("eraser");
            break;
          case "+":
          case "=":
            setZoom(state.zoom + 0.1);
            break;
          case "-":
            setZoom(state.zoom - 0.1);
            break;
          case "0":
            fitToScreen();
            break;
          case "escape":
            if (elements.textInputOverlay.classList.contains("active")) {
              cancelTextInput();
            }
            if (elements.exportModal.classList.contains("active")) {
              elements.exportModal.classList.remove("active");
            }
            break;
        }
      }

      // Initialize the app
      init();
    </script>
  </body>
</html>
